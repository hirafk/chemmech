% ファイル名: chemmech.sty
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{chemmech}[2025/01/03 My ChemFig Arrows]

% ==================================================
% 共通ヘルパー: 結合文字列の解析 (\parsebond)
% 入力: "a1-2" または "a1-a2"
% 出力: \StartNode (a1), \EndNode (a2) という変数を生成
% ==================================================
\newcommand{\parsebond}[1]{%
    \StrCut{#1}{-}\StartNode\EndSuffix%
    \IfInteger{\EndSuffix}{%
        \StrChar{\StartNode}{1}[\Prefix]%
        \edef\EndNode{\Prefix\EndSuffix}%
    }{%
        \let\EndNode\EndSuffix%
    }%
}
% ==================================================
% 3点チェーン解析 (\ParsePath)
% 入力: "a1-2-3" または "a1-a2-a3"
% 出力: \NodeA, \NodeB, \NodeC を生成
% ==================================================
\newcommand{\parsepath}[1]{%
    % 1. 最初のハイフンで分割 (a1 と 2-3)
    \StrCut{#1}{-}\NodeA\RestA%
    
    % 2. 残りをハイフンで分割 (2 と 3)
    \StrCut{\RestA}{-}\SuffixB\SuffixC%
    
    % 3. NodeB の補完処理
    \IfInteger{\SuffixB}{%
        \StrChar{\NodeA}{1}[\Prefix]%
        \edef\NodeB{\Prefix\SuffixB}%
    }{%
        \let\NodeB\SuffixB%
    }%
    
    % 4. NodeC の補完処理 (NodeBのプレフィックスを使う)
    \IfInteger{\SuffixC}{%
        \StrChar{\NodeB}{1}[\PrefixC]%
        \edef\NodeC{\PrefixC\SuffixC}%
    }{%
        \let\NodeC\SuffixC%
    }%
}

\newcommand{\bdclev}[2][1]{
    \parsebond{#2}
    \chemmove{
        % 1. 2点間の角度を計算 (例: 30度)
        \pgfmathanglebetweenpoints
            {\pgfpointanchor{\StartNode}{center}}
            {\pgfpointanchor{\EndNode}{center}}
        \let\bondAng\pgfmathresult
        \pgfmathparse{\bondAng + #1*(90)}
        \let\outAng\pgfmathresult
        \draw[->, shorten <=2pt, shorten >=2pt] 
            ($(\StartNode)!0.5!(\EndNode)$) to[out=\outAng, in=\outAng ,looseness = 1.5,min distance=6mm] (\EndNode);
    }
}
%--------------------------------------------------
%  結合形成 
%    Usage: \bdform[option]{C-O^-} 
% 1で反時計まわりの矢印, -1で反時計周り
% --------------------------------------------------
\newcommand{\bdform}[2][1]{
    \parsebond{#2}
    \chemmove{
        %  2点間の角度を計算 (例: 30度)
        \pgfmathanglebetweenpoints
            {\pgfpointanchor{\StartNode}{center}}
            {\pgfpointanchor{\EndNode}{center}}
        \let\bondAng\pgfmathresult
        \pgfmathparse{\bondAng + #1*90}
        \let\outAng\pgfmathresult
        \draw[->, shorten <=2pt, shorten >=2pt] 
            (\EndNode) to[out=\outAng, in=\outAng ,min distance=5mm] ($(\StartNode)!0.5!(\EndNode)$);
    }
}
%--------------------------------------------------
%  結合移動 / 共役 
%    Usage: \bdrelay{C=C-} 
% 矢印の周り方は小さい角度の方を選択
% --------------------------------------------------
\newcommand{\bdrelay}[1]{
    \parsepath{#1}
    \chemmove{
        \pgfmathanglebetweenpoints{\pgfpointanchor{\NodeA}{center}}{\pgfpointanchor{\NodeB}{center}}
        \let\angOne\pgfmathresult
        \pgfmathanglebetweenpoints{\pgfpointanchor{\NodeB}{center}}{\pgfpointanchor{\NodeC}{center}}
        \let\angTwo\pgfmathresult
        \pgfmathparse{sin(\angTwo - \angOne)}
        \let\sinDiff\pgfmathresult
        \pgfmathparse{\sinDiff > 0 ? 90 : -90}
        \let\autoOffset\pgfmathresult
        \pgfmathparse{\angOne + \autoOffset}
        \let\outAng\pgfmathresult
        \pgfmathparse{\angTwo + \autoOffset}
        \let\inAng\pgfmathresult
        \draw[->, shorten <=2pt, shorten >=2pt] 
            ($(\NodeA)!0.5!(\NodeB)$) 
            to[out=\outAng, in=\inAng ,looseness = 1.5, min distance=6mm] 
            ($(\NodeB)!0.5!(\NodeC)$);
    }
}




% --------------------------------------------------
%    求核攻撃 
%    求核剤NuがAにAの背面からアタック
%    Usage: \nuatk[angle]{Nu}{A-B}
%      - angle: 指定するとその角度で発射。
% ---------------------------------------------------
\newcommand{\nuatk}[3][0]{
    \parsebond{#3}
    \chemmove{
        \pgfmathanglebetweenpoints{\pgfpointanchor{\StartNode}{center}}{\pgfpointanchor{\EndNode}{center}}
        \pgfmathparse{\pgfmathresult + 180 }  
        \let\entryAng\pgfmathresult
        \pgfmathanglebetweenpoints{\pgfpointanchor{#2}{center}}{\pgfpointanchor{\StartNode}{center}}
        \pgfmathparse{\pgfmathresult + #1}
        \let\depAng\pgfmathresult
        \draw[->, shorten <=2pt, shorten >=2pt, looseness=1.2, min distance=10mm] 
            (#2) to[out=\depAng, in=\entryAng] (\StartNode);
    }
}

% --------------------------------------------------
%    求電子攻撃 
%    A=B結合の電子対が、求電子剤(E)を攻撃する
%    Usage: \elatk[in_angle]{A=B}{E}
%      - in_angle: 指定するとその角度で入射。
% ---------------------------------------------------
\newcommand{\elatk}[3][]{
    \parsebond{#2}
    \chemmove{
        \pgfmathanglebetweenpoints{\pgfpointanchor{\StartNode}{center}}{\pgfpointanchor{\EndNode}{center}}
        \let\angBond\pgfmathresult
        \pgfmathanglebetweenpoints{\pgfpointanchor{\StartNode}{center}}{\pgfpointanchor{#3}{center}}
        \let\angTarget\pgfmathresult
        \pgfmathparse{sin(\angTarget - \angBond) > 0 ? 90 : -90}
        \let\sideAng\pgfmathresult
        \pgfmathparse{\angBond + \sideAng}
        \let\outAng\pgfmathresult
        \ifx&#1& 
            \let\inAng\outAng
        \else
            \def\inAng{#1}
        \fi
        \draw[->, shorten <=2pt, shorten >=2pt] 
            ($(\StartNode)!0.5!(\EndNode)$) 
            to[out=\outAng, in=\inAng, looseness=1.2, min distance = 10mm] 
            (#3); 
    }
}